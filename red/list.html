<script type="text/html" data-template-name="Thing List">
  <div class="form-row">
    <label for="node-input-nodeName"><i class="fa fa-tag"></i> Node Name</label>
    <input type="text" id="node-input-nodeName" placeholder="Node Name" />
  </div>
  <div class="form-row">
    <label for="node-input-output"><i class="fa fa-list"></i> Output</label>
    <span>
      <select id="node-input-outputType">
        <option value="array">Array of</option>
        <option value="individual">Individual messages containing</option>
      </select>
      <input id="node-input-output" />
    </span>
  </div>
  <div class="form-row">
    <label for="node-input-property"><i class="fa fa-ellipsis-h"></i> Property</label>
    <input type="text" id="node-input-property" />
  </div>
  <div class="form-row">
    <label for="node-input-discardInput"> &ensp;</label>
    <span>
      <input
        type="checkbox"
        id="node-input-discardInput"
        style="width:25px; vertical-align: baseline"
      />Discard input message
    </span>
  </div>
  <div class="form-row node-input-rule-container-row">
    <ol id="node-input-rule-container"></ol>
  </div>
</script>

<script type="text/javascript">
  // Following variables are declared globally in test.html
  // operators, opHasValue(), thingPropsTypes, basicTypes, typeTypes
  // resizeRule(), resizeRuleContainer(), loadRulesContainer(), saveRules()

  let extendedThingPropsTypes = [
    ...thingPropsTypes.filter(tpt => tpt.value != 'group'),
    {
      value: 'thing',
      label: 'whole thing',
      hasValue: false
    }
  ]

  RED.nodes.registerType('Thing List', {
    paletteLabel: 'list',
    category: 'things',
    color: '#D8BFD8',
    defaults: {
      nodeName: { value: '' },
      outputType: { value: 'array' },
      outputValue: { value: 'name' },
      property: { value: 'payload', required: true },
      discardInput: { value: false },
      rules: { value: [] }
    },
    inputs: 1,
    outputs: 1,
    icon: 'font-awesome/fa-list-ul',
    label: function () {
      return this.nodeName || 'list'
    },
    labelStyle: function () {
      return this.nodeName ? 'node_label_italic' : ''
    },
    oneditprepare: function () {
      let [__, key, path] = this.outputValue.match(/^([a-z]+)(?:\.(.*))?/)
      console.log({ key, path, extendedThingPropsTypes })

      // THIS LINE ONLY: ADJUST FROM (BAD) OLD VERSION
      if (key == 'names') key = 'name'

      $('#node-input-output')
        .typedInput({
          types: extendedThingPropsTypes,
          default: key
        })
        .typedInput('value', path)
        .typedInput('width', 150)

      $('#node-input-property').typedInput({
        types: ['msg']
      })

      loadRulesContainer(this.rules)
    },
    oneditsave: function () {
      this.outputValue = $('#node-input-output').typedInput('type')
      let path = $('#node-input-output').typedInput('value')
      if (
        extendedThingPropsTypes.find(t => t.value == this.outputValue).label.endsWith('.') &&
        path
      )
        this.outputValue += '.' + path

      this.rules = saveRules()
      this.propertyType = $('#node-input-property').typedInput('type')

      $('#node-input-outputs').val($('#node-input-secondOutput').prop('checked') ? 2 : 1)
    },
    oneditresize: resizeRuleContainer
  })
</script>

<script type="text/html" data-help-name="Thing List">
  <p>A node that will list all <i>things</i> that match the specified conditions.</p>
  <h3>Properties</h3>
  <dl class="message-properties">
    <dt class="required">Output</dt>
    <dd>Choose the type and value of the output</dd>
    <dt class="required">Property</dt>
    <dd>Specify what property to output on</dd>
    <dt class="required">Conditions</dt>
    <dd>
      The conditions that must be met to include a <i>thing</i> on the list. Leave empty to list all
      <i>things</i>.
    </dd>
  </dl>
  <h3>Output</h3>
  <p>
    The input message will be forwarded (unless <code>Discard input message</code> is checked), with
    the addition of the output specified in the properties.
  </p>
</script>
